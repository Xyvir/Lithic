name: Windows Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Dependencies
        run: npm install

      # --- DEBUG STEP ---
      # Lists file structure and Tauri environment info to troubleshoot path errors.
      - name: Debug - List Files & Tauri Info
        run: |
          Write-Host "--- CURRENT DIRECTORY ---"
          Get-Location
          
          Write-Host "`n--- FILE STRUCTURE (Depth 3) ---"
          Get-ChildItem -Path . -Recurse -Depth 3 | Select-Object FullName
          
          Write-Host "`n--- TAURI INFO ---"
          npm run tauri info

      # --- FIX PATHS ---
      # Injects the absolute path into tauri.conf.json to satisfy the file watcher
      - name: Fix Tauri Config Paths
        run: |
          $srcAbsPath = (Resolve-Path "src").Path.Replace("\", "/")
          Write-Host "Resolved absolute src path: $srcAbsPath"
          
          $configPath = "src-tauri/tauri.conf.json"
          
          if (Test-Path $configPath) {
            $json = Get-Content $configPath -Raw | ConvertFrom-Json
            
            # Replace relative paths with absolute paths
            $json.build.distDir = $srcAbsPath
            $json.build.devPath = $srcAbsPath
            
            # Save it back
            $json | ConvertTo-Json -Depth 10 | Set-Content $configPath
            Write-Host "Updated tauri.conf.json with absolute paths."
            
            # Print content to verify
            Get-Content $configPath
          } else {
            Write-Error "CRITICAL: tauri.conf.json not found at $configPath"
          }

      - name: Generate Icons
        run: |
          if (Test-Path "src/app-icon.png") {
            npm run tauri icon src/app-icon.png
          } else {
            Write-Host "Icon file 'src/app-icon.png' not found, skipping icon generation."
          }

      - name: Build Offline Executable
        run: npm run tauri build

      - name: Rename Offline Artifact
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Offline.exe"
            Write-Host "Created Lithic-Offline.exe"
          } else {
            Write-Error "Build failed: No .exe found in release folder."
          }

      - name: Switch Config to Online Mode
        run: |
          $configPath = "src-tauri/tauri.conf.json"
          $json = Get-Content $configPath -Raw | ConvertFrom-Json
          
          # Change entry point to website
          if ($json.tauri -and $json.tauri.windows) {
             $json.tauri.windows[0].url = "https://lithic.uk"
          }
          
          $json | ConvertTo-Json -Depth 10 | Set-Content $configPath

      - name: Build Online Executable
        run: npm run tauri build

      - name: Rename Online Artifact
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Online.exe"
             Write-Host "Created Lithic-Online.exe"
          }

      - name: Generate Date-Based Tag
        id: tag
        run: echo "date=v$(Get-Date -Format 'yyyy.MM.dd-HHmm')" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.date }}
          name: Release ${{ steps.tag.outputs.date }}
          draft: false
          prerelease: false
          files: |
            Lithic-Offline.exe
            Lithic-Online.exe
