name: Windows Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # --- 1. GENERATE PACKAGE.JSON ---
      - name: Create Minimal package.json
        run: |
          $pkg = @{
            name = "lithic-build"
            version = "0.0.0"
            private = $true
            scripts = @{
              tauri = "tauri"
            }
            devDependencies = @{
              "@tauri-apps/cli" = "^1"
            }
          }
          $pkg | ConvertTo-Json | Out-File package.json -Encoding UTF8

      - name: Install Dependencies
        run: npm install

      # --- 2. SCAFFOLD TAURI BACKEND ---
      - name: Scaffold Tauri Project (src-tauri)
        run: |
          # 2a. RESOLVE ABSOLUTE PATHS
          if (Test-Path "src") {
             $srcAbsPath = (Resolve-Path "src").Path.Replace("\", "/")
             Write-Host "Resolved src path: $srcAbsPath"
          } else {
             New-Item -ItemType Directory -Force -Path "src"
             $srcAbsPath = (Resolve-Path "src").Path.Replace("\", "/")
             "<h1>Placeholder</h1>" | Out-File "src/launcher.html" -Encoding UTF8
          }

          # 2b. ENSURE ENTRY POINT (Targeting launcher.html)
          # We explicitly look for launcher.html. If missing, we copy the first available HTML to it.
          if (-not (Test-Path "src/launcher.html")) {
             $existingHtml = Get-ChildItem -Path "src" -Filter "*.html" | Select-Object -First 1
             if ($existingHtml) {
                Write-Host "launcher.html not found. Copying $($existingHtml.Name) to src/launcher.html"
                Copy-Item $existingHtml.FullName -Destination "src/launcher.html"
             } else {
                # Last resort fallback
                "<h1>No HTML Found</h1>" | Out-File "src/launcher.html" -Encoding UTF8
             }
          }

          New-Item -ItemType Directory -Force -Path src-tauri/src

          # 2c. Create Cargo.toml
          $cargoToml = @"
          [package]
          name = "lithic"
          version = "0.0.0"
          description = "A Tauri App"
          authors = ["you"]
          edition = "2021"

          [build-dependencies]
          tauri-build = { version = "1", features = [] }

          [dependencies]
          tauri = { version = "1", features = ["api-all"] }
          serde = { version = "1.0", features = ["derive"] }
          serde_json = "1.0"

          [features]
          custom-protocol = ["tauri/custom-protocol"]
          "@
          $cargoToml | Out-File "src-tauri/Cargo.toml" -Encoding UTF8

          # 2d. Create tauri.conf.json
          # Updated: "url": "launcher.html" to match your file structure.
          $tauriConf = @"
          {
            "build": {
              "beforeBuildCommand": "",
              "beforeDevCommand": "",
              "devPath": "$srcAbsPath",
              "distDir": "$srcAbsPath"
            },
            "package": {
              "productName": "Lithic",
              "version": "0.1.0"
            },
            "tauri": {
              "allowlist": {
                "all": true
              },
              "bundle": {
                "active": true,
                "targets": "all",
                "identifier": "com.lithic.app",
                "icon": [
                  "icons/32x32.png",
                  "icons/128x128.png",
                  "icons/128x128@2x.png",
                  "icons/icon.icns",
                  "icons/icon.ico"
                ]
              },
              "security": {
                "csp": null
              },
              "windows": [
                {
                  "url": "launcher.html",
                  "fullscreen": false,
                  "height": 600,
                  "resizable": true,
                  "title": "Lithic",
                  "width": 800
                }
              ]
            }
          }
          "@
          $tauriConf | Out-File "src-tauri/tauri.conf.json" -Encoding UTF8

          # 2e. Create src/main.rs
          $mainRs = @"
          #![cfg_attr(
            all(not(debug_assertions), target_os = "windows"),
            windows_subsystem = "windows"
          )]

          fn main() {
            tauri::Builder::default()
              .run(tauri::generate_context!())
              .expect("error while running tauri application");
          }
          "@
          $mainRs | Out-File "src-tauri/src/main.rs" -Encoding UTF8

          # 2f. Create build.rs
          $buildRs = @"
          fn main() {
            tauri_build::build()
          }
          "@
          $buildRs | Out-File "src-tauri/build.rs" -Encoding UTF8

      # --- 3. ICONS (Optional) ---
      - name: Generate Icons
        run: |
          if (Test-Path "src/app-icon.png") {
            npm run tauri icon src/app-icon.png
          } else {
            Write-Host "Icon file not found, skipping icon generation."
          }

      # --- 4. BUILD OFFLINE ---
      - name: Build Offline Executable
        run: npm run tauri build

      - name: Rename Offline Artifact
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Offline.exe"
            Write-Host "Created Lithic-Offline.exe"
          } else {
            Write-Error "Build failed: No .exe found in release folder."
          }

      # --- 5. SWITCH CONFIG TO ONLINE ---
      - name: Switch Config to Online Mode
        run: |
          $configPath = "src-tauri/tauri.conf.json"
          if (Test-Path $configPath) {
            $json = Get-Content $configPath -Raw | ConvertFrom-Json
            
            # For Tauri v1 structure
            if ($json.tauri -and $json.tauri.windows) {
               $json.tauri.windows[0].url = "https://lithic.uk"
            } 
            
            $json | ConvertTo-Json -Depth 10 | Set-Content $configPath
          }

      # --- 6. BUILD ONLINE ---
      - name: Build Online Executable
        run: npm run tauri build

      - name: Rename Online Artifact
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Online.exe"
             Write-Host "Created Lithic-Online.exe"
          }

      # --- 7. RELEASE ---
      - name: Generate Date-Based Tag
        id: tag
        run: echo "date=v$(Get-Date -Format 'yyyy.MM.dd-HHmm')" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.date }}
          name: Release ${{ steps.tag.outputs.date }}
          draft: false
          prerelease: false
          files: |
            Lithic-Offline.exe
            Lithic-Online.exe
