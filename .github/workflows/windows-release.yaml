name: Windows Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Dependencies
        run: npm install

      - name: Generate Icons
        run: npm run tauri icon src/app-icon.png

      # --- BUILD 1: OFFLINE VERSION ---
      - name: Build Offline Executable
        run: npm run tauri build

      - name: Rename Offline Artifact
        run: |
          Move-Item src-tauri/target/release/LithicApp.exe Lithic-Offline.exe

      # --- CONFIG MODIFICATION ---
      - name: Switch Config to Online Mode
        run: |
          $configPath = "src-tauri/tauri.conf.json"
          $json = Get-Content $configPath -Raw | ConvertFrom-Json
          
          # Change the entry point to the live website
          $json.tauri.windows[0].url = "https://lithic.uk"
          
          # Optional: Point distDir to a dummy location so we don't bundle the local HTML?
          # For now, we leave it; bundling a few KB of unused HTML is safer than breaking the build.
          
          $json | ConvertTo-Json -Depth 10 | Set-Content $configPath

      # --- BUILD 2: ONLINE VERSION ---
      - name: Build Online Executable
        run: npm run tauri build

      - name: Rename Online Artifact
        run: |
          Move-Item src-tauri/target/release/LithicApp.exe Lithic-Online.exe

      # --- RELEASE ---
      - name: Generate Date-Based Tag
        id: tag
        run: echo "date=v$(Get-Date -Format 'yyyy.MM.dd-HHmm')" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.date }}
          name: Release ${{ steps.tag.outputs.date }}
          draft: false
          prerelease: false
          files: |
            Lithic-Offline.exe
            Lithic-Online.exe
