name: Windows Manual Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # --- 1. INSTALL DEPENDENCIES ---
      # This relies on the package.json you committed to the root
      - name: Install Dependencies
        run: npm install

      # --- 2. ICONS (Optional) ---
      # Checks if the icon exists before trying to generate it
      - name: Generate Icons
        run: |
          if (Test-Path "src/app-icon.png") {
            npm run tauri icon src/app-icon.png
          } else {
            Write-Host "Icon file 'src/app-icon.png' not found, skipping icon generation."
          }

      # --- 3. BUILD OFFLINE ---
      - name: Build Offline Executable
        run: npm run tauri build

      - name: Rename Offline Artifact
        # Finds any .exe in the release folder (e.g., Lithic.exe) and renames it
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Offline.exe"
            Write-Host "Created Lithic-Offline.exe"
          } else {
            Write-Error "Build failed: No .exe found in release folder."
          }

      # --- 4. SWITCH CONFIG TO ONLINE ---
      - name: Switch Config to Online Mode
        run: |
          $configPath = "src-tauri/tauri.conf.json"
          if (Test-Path $configPath) {
            $json = Get-Content $configPath -Raw | ConvertFrom-Json
            
            # Change the entry point to the live website
            # Checks for standard Tauri v1 structure
            if ($json.tauri -and $json.tauri.windows) {
               $json.tauri.windows[0].url = "https://lithic.uk"
            } 
            
            $json | ConvertTo-Json -Depth 10 | Set-Content $configPath
          } else {
            Write-Error "tauri.conf.json not found! Ensure it is in the src-tauri folder."
          }

      # --- 5. BUILD ONLINE ---
      - name: Build Online Executable
        run: npm run tauri build

      - name: Rename Online Artifact
        run: |
          $exe = Get-ChildItem -Path "src-tauri/target/release/*.exe" | Select-Object -First 1
          if ($exe) {
            Move-Item $exe.FullName -Destination "Lithic-Online.exe"
             Write-Host "Created Lithic-Online.exe"
          }

      # --- 6. RELEASE ---
      - name: Generate Date-Based Tag
        id: tag
        run: echo "date=v$(Get-Date -Format 'yyyy.MM.dd-HHmm')" >> $env:GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.date }}
          name: Release ${{ steps.tag.outputs.date }}
          draft: false
          prerelease: false
          files: |
            Lithic-Offline.exe
            Lithic-Online.exe
