<!DOCTYPE html>
<html>

<head>
  <title>Lithic - Launcher</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="/manifest.json">
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vollkorn:ital,wght@0,400;0,600;1,400&display=swap" media="print" onload="this.media='all'">

  <noscript>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vollkorn:ital,wght@0,400;0,600;1,400&display=swap">
  </noscript>

  <style>
    :root {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --card-bg: #262626;
      --button-bg: #333333;
      --button-hover: #454545;
      --border-color: #404040;
      --accent-color: #8ab4f8;
      --accent-text: #1a1a1a;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: 'Vollkorn', serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 600px;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 15px;
      position: relative;
    }

    h1 {
      font-weight: 600;
      font-size: 1.8rem;
      margin-top: 5px;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    h1 img {
      height: 1.5em; 
      width: auto;
      margin-right: 15px;
      border-radius: 6px;
    }

    .icon-fallback {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 1.5em;
      width: 1.5em;
      background-color: var(--button-bg);
      border: 2px solid var(--border-color);
      color: var(--text-color);
      border-radius: 6px;
      margin-right: 15px;
      font-weight: 700;
      font-size: 1.2em;
      line-height: 1;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    .section {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 0.8rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      flex-shrink: 0;
    }

    #recent-files {
      flex-grow: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      margin-bottom: 50px;
    }

    #recent-files .section {
      height: 100%;
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
      flex-shrink: 1;
      padding-top: 10px;
    }

    #recent-files ul {
      overflow-y: auto;
      flex-grow: 1;
      padding-right: 5px;
      margin-bottom: 5px;
      scrollbar-width: thin;
      scrollbar-color: var(--button-hover) transparent;
      margin-top: 10px;
    }

    #recent-files ul::-webkit-scrollbar { width: 6px; }
    #recent-files ul::-webkit-scrollbar-track { background: transparent; }
    #recent-files ul::-webkit-scrollbar-thumb {
      background-color: var(--button-hover);
      border-radius: 20px;
    }

    button {
      background-color: var(--button-bg);
      color: var(--text-color);
      font-family: 'Vollkorn', serif;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px 10px;
      cursor: pointer;
      width: 100%;
      text-align: center;
      transition: background-color 0.2s, transform 0.1s;
      margin-top: 0;
      touch-action: manipulation;
    }

    button:hover {
      background-color: var(--button-hover);
      border-color: #666;
    }

    button:active { transform: scale(0.99); }

    ul { list-style-type: none; padding-left: 0; margin: 0; }
    li { margin-bottom: 6px; display: flex; gap: 8px; align-items: center; }
    li>button:first-child {
      flex-grow: 1;
      text-align: left;
      padding-left: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 0;
    }

    .remove-btn {
      width: 44px !important;
      height: 44px;
      padding: 0 !important;
      font-size: 1.5rem;
      line-height: 1;
      color: #888;
      border-color: var(--border-color);
      flex-shrink: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 0;
    }

    .remove-btn:hover {
      color: #ff8a80;
      border-color: #ff8a80;
      background-color: rgba(255, 138, 128, 0.1);
    }

    /* SEARCH STYLES */
    .search-container { position: relative; display: flex; align-items: center; width: 100%; }
    .search-input {
      background-color: var(--button-bg);
      border: 1px solid var(--border-color);
      color: var(--text-color);
      padding: 10px 35px 10px 10px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 1rem;
      width: 100%;
    }
    .search-input:focus { outline: none; border-color: var(--accent-color); }
    .search-clear {
      position: absolute; right: 5px; background: none; border: none; color: #888;
      cursor: pointer; font-size: 1.4rem; padding: 5px; line-height: 1;
      display: none; margin-top: 0; width: auto;
    }
    .clear-btn {
      margin-top: auto; font-size: 0.9rem; text-align: center;
      background: transparent; border: 1px dashed var(--border-color);
      opacity: 0.7; flex-shrink: 0; padding: 8px;
    }
    .clear-btn:hover { background-color: rgba(255, 255, 255, 0.05); opacity: 1; }

    #github-link {
      position: fixed; bottom: 15px; left: 15px;
      background-color: var(--button-bg); color: var(--text-color);
      border: 1px solid var(--border-color); border-radius: 6px;
      padding: 8px 12px; font-size: 0.75rem; text-decoration: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      transition: background-color 0.2s, transform 0.1s;
      z-index: 1000; text-align: center; line-height: 1.2;
    }

    #install-pwa {
      display: none; position: fixed; bottom: 15px; right: 15px; width: auto;
      background-color: var(--accent-color); color: var(--accent-text);
      font-weight: 600; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: none; z-index: 1000; animation: fadein 1s;
      padding: 10px 15px; border-radius: 6px; cursor: pointer; margin-top: 0;
    }
    @keyframes fadein { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 600px) {
      #github-link { display: none; }
      #recent-files { margin-bottom: 0; }
    }
    @media all and (display-mode: standalone) {
      #install-pwa, #github-link { display: none !important; }
      #recent-files { margin-bottom: 0; }
    }
  </style>

  <script type="module">
    import { get, set, del } from 'https://cdn.jsdelivr.net/npm/idb-keyval@6/+esm';
    window.idb = { get, set, del };

    // GLOBAL MEMORY CACHE
    // We store handles here so we can access them INSTANTLY on click
    // without waiting for IndexedDB (which kills the permission timer).
    window.FILE_CACHE = new Map();

    // --- MAIN ACTIONS ---

    window.openFile = async function(fileName) {
      let fileHandle;

      // 1. FAST LOOKUP (RAM)
      // Grab handle from RAM. Do not await IDB here.
      if (fileName && window.FILE_CACHE.has(fileName)) {
          fileHandle = window.FILE_CACHE.get(fileName);
      } else {
          // Fallback to picker
          try {
             [fileHandle] = await window.showOpenFilePicker({
                types: [{ description: 'HTML Files', accept: { 'text/html': ['.html', '.htm'] } }]
             });
          } catch (e) { return; }
      }

      // 2. CHECK ACCESS (The Chrome Fix)
      // Try to read first. If successful, we have implicit folder access and skip the prompt.
      let hasAccess = false;
      try {
          await fileHandle.getFile();
          hasAccess = true;
      } catch (e) {
          hasAccess = false;
      }

      // 3. ASK ONLY IF NEEDED
      if (!hasAccess) {
          try {
             const mode = 'readwrite';
             if ((await fileHandle.requestPermission({ mode })) !== 'granted') {
                 alert("Permission denied.");
                 return;
             }
          } catch (e) {
             alert("Error requesting permission: " + e.message);
             return;
          }
      }

      // 4. LOAD THE WIKI
      // Save to IDB (for the Service Worker) and Reload
      try {
          await idb.set('activeFile', fileHandle);
          await addToRecents(fileHandle);
          window.location.reload(); 
      } catch (e) {
          alert("Save failed: " + e.message);
      }
    };

    window.mountFolder = async function() {
      try {
        // REQUEST READWRITE UP FRONT
        // This is critical for Chrome Android to prevent freeze on file access
        const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
        
        await idb.set('activeDirHandle', dirHandle);
        
        let count = 0;
        window.FILE_CACHE.clear(); // Refresh cache

        for await (const entry of dirHandle.values()) {
          if (entry.kind === 'file' && (entry.name.endsWith('.html') || entry.name.endsWith('.htm'))) {
            window.FILE_CACHE.set(entry.name, entry);
            count++;
          }
        }
        
        // Persist
        const filesArray = Array.from(window.FILE_CACHE.values());
        await idb.set('recentFiles', filesArray);
        
        displayRecentFiles(); 
        alert(`Mounted ${count} files with Write Access.`);
        
      } catch (e) {
        if (e.name !== 'AbortError') alert("Mount failed: " + e.message);
      }
    };

    // --- UI UTILS ---

    async function hydrateCache() {
        try {
            const recents = (await idb.get('recentFiles')) || [];
            recents.forEach(f => window.FILE_CACHE.set(f.name, f));
            displayRecentFiles();
        } catch(e) { console.error("Cache hydration failed", e); }
    }

    async function addToRecents(fileHandle) {
       window.FILE_CACHE.set(fileHandle.name, fileHandle);
       const filesArray = Array.from(window.FILE_CACHE.values());
       await idb.set('recentFiles', filesArray);
    }

    window.removeRecent = async function(name) {
       window.FILE_CACHE.delete(name);
       const filesArray = Array.from(window.FILE_CACHE.values());
       await idb.set('recentFiles', filesArray);
       displayRecentFiles();
    }

    window.clearRecent = async function() {
       window.FILE_CACHE.clear();
       await idb.del('recentFiles');
       displayRecentFiles();
    }

    window.displayRecentFiles = function() {
      const elem = document.getElementById("recent-files");
      if (!elem) return;
      elem.innerHTML = "";
      
      const recentFiles = Array.from(window.FILE_CACHE.values());
      if (recentFiles.length === 0) return;

      const sectionDiv = document.createElement('div');
      sectionDiv.className = 'section';
      
      const searchContainer = document.createElement('div');
      searchContainer.className = 'search-container';
      const searchInput = document.createElement('input');
      searchInput.className = 'search-input';
      searchInput.placeholder = 'Search local files...';
      const searchClear = document.createElement('button');
      searchClear.className = 'search-clear';
      searchClear.innerHTML = '&times;';
      searchContainer.append(searchInput, searchClear);
      sectionDiv.appendChild(searchContainer);

      const list = document.createElement('ul');
      recentFiles.forEach(file => {
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.innerText = file.name;
          btn.onclick = () => window.openFile(file.name);
          
          const rmv = document.createElement('button');
          rmv.className = 'remove-btn';
          rmv.innerHTML = '&times;';
          rmv.onclick = (e) => { e.stopPropagation(); window.removeRecent(file.name); };
          
          li.append(btn, rmv);
          list.append(li);
      });
      sectionDiv.appendChild(list);
      
      const clr = document.createElement('button');
      clr.className = 'clear-btn';
      clr.innerText = 'Clear All';
      clr.onclick = window.clearRecent;
      sectionDiv.appendChild(clr);
      
      searchInput.addEventListener('input', (e) => {
         const val = e.target.value.toLowerCase();
         Array.from(list.children).forEach(li => {
            const txt = li.firstChild.innerText.toLowerCase();
            li.style.display = txt.includes(val) ? '' : 'none';
         });
         searchClear.style.display = val ? 'block' : 'none';
      });
      searchClear.onclick = () => { searchInput.value = ''; searchInput.dispatchEvent(new Event('input')); };

      elem.appendChild(sectionDiv);
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/offline-service-worker.js', { scope: '/' })
        .then(() => console.log('SW Registered'));
    }
    
    // Start hydration immediately
    hydrateCache();
  </script>
</head>

<body>
  <div class="container">
    <h1>
      <div class="icon-fallback">L</div>
      Lithic
    </h1>

    <div class="section">
      <button onclick="openFile()">Use "Starter Lith"</button>
    </div>

    <div class="section">
      <button onclick="mountFolder()">Mount a Folder...</button>
    </div>

    <div id="recent-files"></div>

    <a id="github-link" href="https://github.com/xyvir/lithic" target="_blank">View on GitHub</a>
  </div>
</body>
</html>
